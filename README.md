# Итоговый проект

Проект для финтех-стартапа, который предлагает международные банковские услуги через приложение: пользователи могут безопасно переводить деньги в разные страны. 
Система собирает данные по транзакционной активности пользователей и обновляет таблицы с курсом валют. 

### Описание

Выгрузка данных из PostgreSQL в DWH с помощью DAG в Airflow: обработка информации в рамках ETL-процесса.
В качестве источника данных выбрано хранилище в PostgreSQL.
Хранилище в компании реализовано на Vertica. 
После построения пайплайна обработки данных отдельно реализован пайплайн формирования витрины с помощью Airflow и DAG. 
Также реализована BI-аналитика для компании: подключение из Metabase к Vertica и реализован дашборд.

### Структура репозитория

Внутри `src` расположены папки:
- `/src/dags` - код DAG, который создает таблицы `0_init_dag.py`, который поставляет данные из источника в хранилище `1_data_import.py`, который обновляет витрины данных `2_datamart_update.py`.
- `/src/sql` - SQL-запросы формирования таблиц в `STAGING`- и `CDM`-слоях, а также скрипты подготовки данных для итоговой витрины.
- `/src/img` - скриншот реализованного над витриной дашборда.

### Описание источника PostgreSQL:

В компании запущена PostgreSQL для продакшена. 
Для построения инфраструктуры аналитики и поставки данных предоставлена отдельная PostgreSQL, копия продовой БД. 
В таблицах public.transactions и public.currencies есть доступ на загрузку данных.

Для доступа к БД создана учётная запись:
```
    "database": "db1",
    "host" : "rc1b-w5d285tmxa8jimyn.mdb.yandexcloud.net",
    "port" : 6432,
    "username" : “student”,
    "password" : "de_student_112022".
```

#### Структура данных TRANSACTION:

 - operation_id — id транзакции;
 - account_number_from — внутренний бухгалтерский номер счёта транзакции ОТ КОГО;
 - account_number_to — внутренний бухгалтерский номер счёта транзакции К КОМУ;
 - currency_code — трёхзначный код валюты страны, из которой идёт транзакция;
 - country — страна-источник транзакции;
 - status — статус проведения транзакции: queued («транзакция в очереди на обработку сервисом»), in_progress («транзакция в обработке»), blocked («транзакция заблокирована сервисом»), done («транзакция выполнена успешно»), chargeback («пользователь осуществил возврат по транзакции»).
 - transaction_type — тип транзакции во внутреннем учёте: authorisation («авторизационная транзакция, подтверждающая наличие счёта пользователя»), sbp_incoming («входящий перевод по системе быстрых платежей»), sbp_outgoing («исходящий перевод по системе быстрых платежей»), transfer_incoming («входящий перевод по счёту»), transfer_outgoing («исходящий перевод по счёту»), c2b_partner_incoming («перевод от юридического лица»), c2b_partner_outgoing («перевод юридическому лицу»).
 - amount — целочисленная сумма транзакции в минимальной единице валюты страны (копейка, цент, куруш);
 - transaction_dt — дата и время исполнения транзакции до миллисекунд.

#### Структура данных CURRENCIES:

 - date_update — дата обновления курса валют;
 - currency_code — трёхзначный код валюты транзакции;
 - currency_code_with — отношение другой валюты к валюте трёхзначного кода;
 - currency_code_div — значение отношения единицы одной валюты к единице валюты транзакции.


### Описание БД VERTICA

 - Имеются 2 таблицы в STG: YAMARSELR2015YANDEXRU__STAGING.transaction и YAMARSELR2015YANDEXRU__STAGING.currencies.
 - Витрина: YAMARSELR2015YANDEXRU.global_metrics

#### Подключение:
```
{
    "host": "51.250.75.20",
    "port": "5433",
    "user": yamarselr2015yandexru,
    "password": EWgR2UjZH2TX6LP,
    "database": "dwh",
    "autocommit": True,
}
```
#### Структура витрины global_metrics:
 - date_update — дата расчёта,
 - currency_from — код валюты транзакции;
 - amount_total — общая сумма транзакций по валюте в долларах;
 - cnt_transactions — общий объём транзакций по валюте;
 - avg_transactions_per_account — средний объём транзакций с аккаунта;
 - cnt_accounts_make_transactions — количество уникальных аккаунтов с совершёнными транзакциями по валюте.